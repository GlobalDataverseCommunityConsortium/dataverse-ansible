---

- name: flush handlers to restart Payara if needed
  meta: flush_handlers

- ansible.builtin.import_tasks: aws_config.yml

- name: escape custom endpoint url colons
  ansible.builtin.set_fact: "custom_endpoint_escaped={{ s3.custom_endpoint_url | regex_replace (':','\\:') }}"
  when: s3.custom_endpoint_url | length > 0

- name: build list of s3 datastores
  ansible.builtin.set_fact:
    s3_datastores: "

#- name: create localstack bucket for testing
#  shell: 'aws --endpoint={{ custom_endpoint_escaped }} s3 mb s3://{{ s3.bucket_name }}'
#  when: s3.custom_endpoint_url | length > 0

- name: create localstack buckets for testing
  ansible.builtin.debug:
    msg: 'aws --endpoint={{ custom_endpoint_escaped }} s3 mb s3://{{ item[0].bucket-name }}'
  loop: "{{ lookup('ansible.builtin.dict', buckets) }}"
